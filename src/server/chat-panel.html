<style>
  .chat-panel {
    position: fixed;
    top: 0; right: 0; bottom: 0;
    width: 420px;
    z-index: 200;
    display: flex;
    flex-direction: column;
    background: #F3F4F6;
    border-left: 1px solid #ddd;
  }
  .chat-header {
    padding: 14px 20px;
    border-bottom: 1px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .chat-header h2 {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: #333;
  }
  .chat-header button {
    background: none; border: none;
    color: #888; cursor: pointer;
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    padding: 4px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    transition: all 0.15s;
  }
  .chat-header button:hover { color: #333; border-color: #999; }

  .chat-header select {
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    color: #333;
    padding: 4px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #fff;
    cursor: pointer;
    outline: none;
    transition: border-color 0.15s;
  }
  .chat-header select:hover { border-color: #999; }
  .chat-header select:focus { border-color: #2a5a9a; }
  .chat-header-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .chat-messages::-webkit-scrollbar { width: 4px; }
  .chat-messages::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }

  .chat-msg {
    padding: 10px 14px;
    border-radius: 10px;
    font-size: 13px;
    line-height: 1.5;
    max-width: 95%;
    word-wrap: break-word;
  }
  .chat-msg.user {
    background: #e3ecf7;
    color: #1a3a5c;
    align-self: flex-end;
    border-bottom-right-radius: 3px;
  }
  .chat-msg.assistant {
    background: #fff;
    color: #333;
    align-self: flex-start;
    border-bottom-left-radius: 3px;
    border: 1px solid #e0e0e0;
  }
  .chat-msg.assistant .sources {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #e8e8e8;
    font-size: 10px;
    color: #888;
    font-family: 'Inter', sans-serif;
  }
  .chat-msg.assistant .sources div {
    padding: 1px 0;
    cursor: pointer;
    color: #e67e22;
    transition: color 0.12s;
  }
  .chat-msg.assistant .sources div:hover { color: #d35400; }

  .chat-msg.system {
    background: transparent;
    color: #aaa;
    font-size: 11px;
    text-align: center;
    font-family: 'Inter', sans-serif;
    align-self: center;
    padding: 4px;
  }

  .chat-input-area {
    padding: 12px 20px 16px;
    border-top: 1px solid #ddd;
    display: flex;
    gap: 8px;
  }
  .chat-input-area input {
    flex: 1;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid #ddd;
    background: #fff;
    color: #333;
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
  }
  .chat-input-area input:focus { border-color: #2a5a9a; }
  .chat-input-area input::placeholder { color: #bbb; }
  .chat-input-area button {
    padding: 10px 16px;
    border-radius: 8px;
    border: none;
    background: #2a5a9a;
    color: #fff;
    font-size: 13px;
    cursor: pointer;
    font-family: 'Inter', sans-serif;
    font-weight: 500;
    transition: background 0.15s;
  }
  .chat-input-area button:hover { background: #3a7bd5; }
  .chat-input-area button:disabled { opacity: 0.4; cursor: not-allowed; }

  .typing-indicator {
    display: none;
    align-self: flex-start;
    padding: 8px 14px;
    font-size: 12px;
    color: #999;
    font-family: 'Inter', sans-serif;
  }
  .typing-indicator.visible { display: block; }
  .typing-indicator span {
    animation: blink 1.4s infinite;
  }
  .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
  .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes blink { 0%,60%,100% { opacity: 0.2; } 30% { opacity: 1; } }

  /* Adjust graph area for chat panel */
  #graph-container { left: 280px; right: 420px; }
  .control-panel { z-index: 50; }
</style>

<div class="chat-panel">
  <div class="chat-header">
    <h2>Ask the knowledge base</h2>
    <div class="chat-header-controls">
      <select id="index-selector" onchange="switchIndex(this.value)"></select>
      <button onclick="clearChat()">Clear</button>
    </div>
  </div>
  <div class="chat-messages" id="chat-messages">
    <div class="chat-msg system" id="chat-welcome">Ask a question about the knowledge base</div>
  </div>
  <div class="typing-indicator" id="typing">
    Searching<span>.</span><span>.</span><span>.</span>
  </div>
  <div class="chat-input-area">
    <input type="text" id="chat-input" placeholder="Ask a question..." />
    <button id="chat-send" onclick="sendMessage()">Ask</button>
  </div>
</div>

<script>
// ── Chat Logic ──────────────────────────────────────────

const chatInput = document.getElementById('chat-input');
const chatMessages = document.getElementById('chat-messages');
const chatSend = document.getElementById('chat-send');
const typingEl = document.getElementById('typing');
const indexSelector = document.getElementById('index-selector');

// Load available indexes on startup
(async function loadIndexes() {
  try {
    const resp = await fetch('/api/indexes');
    const indexes = await resp.json();
    indexSelector.innerHTML = '';
    let activeName = '';
    for (const idx of indexes) {
      const opt = document.createElement('option');
      opt.value = idx.name;
      opt.textContent = idx.name + ' (' + idx.chunks + ' chunks)';
      if (idx.active) { opt.selected = true; activeName = idx.name; }
      indexSelector.appendChild(opt);
    }
    const welcome = document.getElementById('chat-welcome');
    if (welcome && activeName) welcome.textContent = 'Ask a question about ' + activeName;
  } catch (e) {
    console.error('Failed to load indexes:', e);
  }
})();

async function switchIndex(name) {
  chatSend.disabled = true;
  indexSelector.disabled = true;
  addMessage('system', 'Switching to ' + name + '...');
  try {
    const resp = await fetch('/api/switch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ index: name }),
    });
    const data = await resp.json();
    if (data.error) {
      addMessage('system', 'Error: ' + data.error);
    } else {
      // Reload graph with new viz data
      if (data.vizData && typeof initGraph === 'function') {
        initGraph(data.vizData);
      }
      chatMessages.innerHTML = '';
      addMessage('system', 'Ask a question about ' + name);
    }
  } catch (e) {
    addMessage('system', 'Switch failed: ' + e.message);
  }
  chatSend.disabled = false;
  indexSelector.disabled = false;
}

chatInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

async function sendMessage() {
  const query = chatInput.value.trim();
  if (!query) return;

  chatInput.value = '';
  chatSend.disabled = true;

  // Add user message
  addMessage('user', query);

  // Show typing
  typingEl.classList.add('visible');
  chatMessages.scrollTop = chatMessages.scrollHeight;

  try {
    const resp = await fetch('/api/ask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query }),
    });

    const data = await resp.json();

    typingEl.classList.remove('visible');

    if (data.error) {
      addMessage('system', 'Error: ' + data.error);
    } else {
      // Add answer with sources
      let sourcesHtml = '';
      if (data.sources && data.sources.length > 0) {
        sourcesHtml = '<div class="sources">' +
          data.sources.map(s => {
            const pg = s.pageStart === s.pageEnd ? 'p.' + s.pageStart : 'pp.' + s.pageStart + '-' + s.pageEnd;
            const label = s.file.replace(/\.md$/, '').split('/').pop();
            if (s.url) {
              return '<div data-doc="doc:' + s.file.replace(/"/g, '&quot;') + '" data-url="' + s.url.replace(/"/g, '&quot;') + '">[' + s.index + '] ' + label + ' (' + pg + ') ↗</div>';
            }
            return '<div data-doc="doc:' + s.file.replace(/"/g, '&quot;') + '">[' + s.index + '] ' + label + ' (' + pg + ')</div>';
          }).join('') +
          '</div>';
      }
      addMessage('assistant', data.answer, sourcesHtml);

      // Highlight graph path
      if (data.path) {
        highlightPath(data.path);
      }
    }
  } catch (e) {
    typingEl.classList.remove('visible');
    addMessage('system', 'Connection error: ' + e.message);
  }

  chatSend.disabled = false;
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addMessage(role, text, extraHtml = '') {
  const div = document.createElement('div');
  div.className = 'chat-msg ' + role;
  // Simple markdown-like formatting
  let html = text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\[Source (\d+)\]/g, '<strong style="color:#e67e22">[Source $1]</strong>')
    .replace(/\n/g, '<br>');
  div.innerHTML = html + extraHtml;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Event delegation for source clicks — open URL if available, else focus graph node
chatMessages.addEventListener('click', function(e) {
  const sourceEl = e.target.closest('[data-doc]');
  if (sourceEl) {
    if (sourceEl.dataset.url) {
      window.open(sourceEl.dataset.url, '_blank');
    } else {
      focusNode(sourceEl.dataset.doc);
    }
  }
});

function clearChat() {
  chatMessages.innerHTML = '';
  const name = indexSelector.value || 'the knowledge base';
  chatMessages.innerHTML = '<div class="chat-msg system" id="chat-welcome">Ask a question about ' + name + '</div>';
  fetch('/api/forget', { method: 'POST' });
  if (typeof clearPath === 'function') clearPath();
}

// highlightPath and focusNode are defined in graph-viz.html (vis-network)
// No need to redefine them here.
</script>
